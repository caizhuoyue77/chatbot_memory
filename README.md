# 网易作业：记忆与规划系统

## 项目概述
本项目旨在开发一个结合记忆功能的角色扮演对话系统。系统能够通过对话学习用户的偏好，并在后续对话中利用这些记忆提供更加个性化的回复。

## 项目展示

从对话中抽取记忆

![记忆抽取](./assets/记忆抽取.gif)

在对话中利用抽取得到的记忆

![记忆利用](./assets/记忆利用.gif)

## 启动指南

### 使用 Docker Compose 启动

```bash
docker-compose build
```
```bash
docker-compose up
```

启动后，访问 [http://localhost:8501](http://localhost:8501) 即可使用。初次启动时，若遇到8000端口无法连接的情况，请稍等片刻。

### 本地启动步骤
1. **创建 Conda 环境并安装依赖**
    ```bash
    conda create -n chatbot-mem python==3.10
    conda activate chatbot-mem
    pip install -r requirements.txt
    ```

2. **启动后端服务**
    ```bash
    fastapi dev chat.py
    ```

3. **启动前端服务**
    ```bash
    streamlit run chat_frontend.py
    ```

## 开发进度与待办事项
- [x] 异常处理：memory.txt 不存在时的处理
- [x] 记忆筛选：根据阈值筛选记忆
- [x] 模型支持：添加 deepseek 和 moonshot 模型
- [ ] 模型鲁棒性：多添加几个API key，充多一点钱，不然可能有rate limit
- [x] 前后端改进：支持页面配置角色设定
- [x] 前后端改进：支持选择对话模型和记忆模型
- [x] 前后端改进：支持配置记忆检索阈值
- [x] 前后端改进：清空所有记忆
- [x] 拟人化回复用户
- [x] 利用 LLM 协助提取记忆
- [x] 记忆内容的向量化
- [x] 记忆存储到 txt 文件
- [x] 获取所有记忆
- [x] 计算与所有记忆的相似度
- [x] 记忆搜索功能
- [x] 记忆展示页面
- [x] 添加记忆时的提示
- [x] 提取多条记忆的对话
- [x] 处理聊天 rate limit 和资金不足的错误
- [x] Docker 化后端和模型相关部分
- [x] 向量搜索所有记忆
- [x] 在拟人回复中利用记忆
- [x] 对话页面前端
- [ ] 进阶：用户登录和针对不同用户的记忆
- [ ] 进阶：更新记忆（相似度+prompt判断）
- [ ] 进阶：删除记忆（相似度+prompt判断）

## 系统功能与页面设计

### 页面 1: 聊天与配置页面
- **功能**：
    - 拟人化聊天
    - 配置记忆与聊天相关参数
    - 显示记忆的变动

### 页面 2: 记忆查询与展示页面
- **功能**：
    - 根据标签 (tag) 搜索记忆
    - 根据关键字搜索记忆
    - 展示所有记忆

## 接口设计

1. **模型调用接口**
2. **拟人聊天接口**
    - 输入：用户输入
    - 输出：角色回复 + 是否抽取记忆
    - **备注**：可使用小模型实现
3. **连贯聊天接口**
    - 需求：维护当前上下文窗口，可清空上下文
    - **备注**：建议设计为一个类来处理
4. **记忆抽取接口**
    - 输入：聊天记录
    - 输出：抽取的记忆
5. **记忆查询接口**
    - 输入：查询模式、关键字/tag
    - 输出：所有匹配的记忆

## 逻辑与算法设计

### 1. 记忆抽取
- **目标**：识别用户偏好信息
- **实现**：每次生成回答时提取用户偏好
- **频率**：每句话生成时进行一次
- **示例**：用户喜欢吃鱼

### 2. 记忆更新
- **目标**：更新已有记忆
- **实现**：通过相似度匹配和 LLM 判断
- **示例**：更新用户的饮食习惯

### 3. 记忆利用
- **目标**：将记忆融入对话
- **实现**：通过相似度匹配，将相关记忆加入对话提示
- **示例**：使用相关记忆增强对话个性化

## 架构与技术选型

1. **实现方式**：面向对象设计
2. **开发流程**：自底向上，从后端开始
3. **记忆存储格式**：
    - **字段**：内容、时间戳、tag、用户 ID、记忆 ID
4. **技术选型**:
    - **拟人模型**：deepseek（成本效益高）
    - **前端**：streamlit（界面美观）
    - **后端**：fastapi（高效、易用）